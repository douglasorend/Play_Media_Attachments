<?xml version="1.0"?>
<!DOCTYPE modification SYSTEM "http://www.simplemachines.org/xml/modification">
<modification xmlns="http://www.simplemachines.org/xml/modification" xmlns:smf="http://www.simplemachines.org/">
<id>Dougiefresh:PlayAttachments</id>
<name>Play Media Attachment</name>
<version>1.2</version>

<!-------------------------------------------------------------------------->
<!-- Source file changes                                                  -->
<!-------------------------------------------------------------------------->
<file name="$sourcedir/Display.php">
	<!-- Display function -->
	<operation>
		<search position="after"><![CDATA[a.width, a.height]]></search>
		<add><![CDATA[a.mime_type, ]]></add>
	</operation>
	
	<!-- loadAttachmentContext function -->
	<operation>
		<search position="before"><![CDATA['is_approved' => $attachment['approved'],]]></search>
		<add><![CDATA[
				'is_audio' => strpos($attachment['mime_type'], 'audio/') !== false,
				'is_video' => strpos($attachment['mime_type'], 'video/') !== false,
				'mime_type' => $attachment['mime_type'],]]></add>
	</operation>
	
	<!-- Download function -->
	<operation>
		<search position="after"><![CDATA[// Does this have a mime type?]]></search>
		<add><![CDATA[// Is this an supported audio or video file?
	elseif (!empty($mime_type) && (strpos($mime_type, 'audio/') !== false || strpos($mime_type, 'video/') !== false))
		header('Content-Type: ' . $mime_type);
	
	]]></add>
	</operation>
</file>
<file name="$sourcedir/Subs-Post.php">
	<!-- createAttachment function -->
	<operation>
		<search position="after"><![CDATA[// It is possible we might have a MIME type that isn't actually an image but still have a size.]]></search>
		<add><![CDATA[// Check to see if it is a audio or video file:
	if (empty($attachmentOptions['mime_type']) && empty($attachmentOptions['width']))
	{
		require_once($sourcedir . '/Subs-MediaAttachments.php');
		$attachmentOptions['mime_type'] = PMA_mime_type($attachmentOptions['tmp_name'], $attachmentOptions['name']);
	}

	]]></add>
	</operation>
</file>

<!-------------------------------------------------------------------------->
<!-- Template changes                                                     -->
<!-------------------------------------------------------------------------->
<file name="$themedir/Display.template.php">
	<!-- template_main function -->
	<operation>
		<search position="after"><![CDATA[if ($attachment['is_image'])]]></search>
		<add><![CDATA[if (!empty($attachment['is_audio']))
				{
					echo '
										<audio controls="controls">
											<source src="', $attachment['href'], '" type="', $attachment['mime_type'], '">
											', $txt['PMA_no_audio'], '
										</audio><br />';
				}

				]]></add>
	</operation>
</file>
</modification>